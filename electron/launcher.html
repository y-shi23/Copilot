<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anywhere Launcher</title>
  <style>
    :root {
      --bg-main: #11161f;
      --bg-card: rgba(26, 34, 46, 0.86);
      --bg-card-hover: rgba(37, 49, 67, 0.95);
      --border: rgba(130, 168, 224, 0.26);
      --text-main: #f6f9ff;
      --text-sub: rgba(214, 227, 246, 0.72);
      --accent: #77c3ff;
      --danger: #ff8e8e;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: transparent;
      font-family: "IBM Plex Sans", "Noto Sans SC", "Segoe UI", sans-serif;
      color: var(--text-main);
    }

    body {
      padding: 12px;
    }

    .launcher-shell {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      border: 1px solid var(--border);
      background:
        radial-gradient(circle at 88% 4%, rgba(133, 193, 255, 0.16), transparent 42%),
        radial-gradient(circle at 8% 98%, rgba(118, 244, 212, 0.12), transparent 45%),
        linear-gradient(164deg, #0f141d 0%, #151d29 62%, #0f1521 100%);
      box-shadow:
        0 30px 72px rgba(3, 6, 10, 0.42),
        0 12px 24px rgba(2, 5, 8, 0.5);
      display: grid;
      grid-template-rows: auto auto auto 1fr auto auto;
      gap: 10px;
      padding: 16px;
      position: relative;
      overflow: hidden;
      -webkit-app-region: drag;
    }

    .launcher-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(rgba(255, 255, 255, 0.05) 0.75px, transparent 0.75px);
      background-size: 3px 3px;
      opacity: 0.25;
      mix-blend-mode: soft-light;
    }

    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }

    .title {
      font-size: 31px;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #dff2ff;
    }

    .meta {
      font-size: 12px;
      color: var(--text-sub);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .input-shell {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .no-drag {
      -webkit-app-region: no-drag;
    }

    #queryInput {
      flex: 1;
      border: 1px solid rgba(147, 183, 230, 0.26);
      border-radius: 12px;
      background: rgba(17, 24, 35, 0.9);
      color: var(--text-main);
      font-size: 17px;
      padding: 12px 14px;
      outline: none;
      transition: border-color 0.18s ease, box-shadow 0.18s ease;
      font-family: inherit;
    }

    #queryInput::placeholder {
      color: rgba(195, 215, 242, 0.48);
    }

    #queryInput:focus {
      border-color: rgba(132, 198, 255, 0.8);
      box-shadow: 0 0 0 3px rgba(119, 195, 255, 0.16);
    }

    #clearAttachmentBtn {
      border: 1px solid rgba(140, 178, 226, 0.32);
      background: rgba(22, 30, 43, 0.92);
      color: var(--text-main);
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.18s ease, border-color 0.18s ease;
      font-family: inherit;
    }

    #clearAttachmentBtn:hover {
      background: rgba(35, 47, 66, 0.96);
      border-color: rgba(154, 199, 255, 0.58);
    }

    .payload-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      border-radius: 10px;
      border: 1px solid rgba(130, 178, 238, 0.22);
      padding: 9px 12px;
      background: rgba(18, 25, 37, 0.82);
      color: #d9ecff;
      font-size: 13px;
      position: relative;
      z-index: 1;
    }

    .payload-bar.visible {
      display: flex;
    }

    .payload-kind {
      color: var(--accent);
      margin-right: 8px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .result-list {
      display: none;
      margin: 0;
      padding: 0;
      list-style: none;
      overflow: auto;
      position: relative;
      z-index: 1;
      border-radius: 12px;
      border: 1px solid rgba(134, 173, 230, 0.18);
      background: rgba(10, 14, 21, 0.45);
    }

    .result-list.visible {
      display: block;
    }

    .result-list::-webkit-scrollbar {
      width: 7px;
    }

    .result-list::-webkit-scrollbar-thumb {
      border-radius: 8px;
      background: rgba(126, 166, 220, 0.3);
    }

    .prompt-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(120, 157, 209, 0.14);
      cursor: pointer;
      transition: background 0.16s ease;
    }

    .prompt-item:last-child {
      border-bottom: none;
    }

    .prompt-item.selected {
      background: rgba(67, 96, 136, 0.38);
    }

    .prompt-item:hover {
      background: var(--bg-card-hover);
    }

    .prompt-icon {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-size: 13px;
      font-weight: 700;
      color: #dbeeff;
      background: rgba(41, 57, 79, 0.85);
      border: 1px solid rgba(133, 174, 232, 0.28);
      overflow: hidden;
      user-select: none;
    }

    .prompt-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .prompt-title {
      font-size: 15px;
      color: #f3f8ff;
      margin-bottom: 2px;
    }

    .prompt-desc {
      font-size: 12px;
      color: var(--text-sub);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .prompt-tag {
      font-size: 11px;
      color: #b9ddff;
      border: 1px solid rgba(130, 193, 255, 0.42);
      border-radius: 999px;
      padding: 4px 10px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .empty-state {
      padding: 26px 16px;
      color: var(--text-sub);
      font-size: 14px;
      text-align: center;
    }

    .status-line {
      min-height: 18px;
      font-size: 12px;
      color: var(--text-sub);
      position: relative;
      z-index: 1;
    }

    .status-line.error {
      color: var(--danger);
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      font-size: 11px;
      color: rgba(205, 223, 248, 0.64);
      letter-spacing: 0.03em;
      position: relative;
      z-index: 1;
      flex-wrap: wrap;
    }

    .drag-over {
      border-color: rgba(126, 208, 255, 0.72);
      box-shadow: 0 0 0 2px rgba(119, 195, 255, 0.22) inset;
    }
  </style>
</head>
<body>
  <main class="launcher-shell" id="launcherShell">
    <header class="header">
      <div class="title">快捷助手</div>
      <div class="meta" id="resultCount">0 / 0</div>
    </header>

    <div class="input-shell no-drag">
      <input
        id="queryInput"
        type="text"
        autocomplete="off"
        spellcheck="false"
        placeholder="输入文本、粘贴图片或拖拽文件，回车执行"
      />
      <button id="clearAttachmentBtn" type="button" hidden>清除附件</button>
    </div>

    <div class="payload-bar no-drag" id="payloadBar">
      <div>
        <span class="payload-kind" id="payloadKind"></span>
        <span id="payloadText"></span>
      </div>
      <span>仅显示可处理该输入的助手</span>
    </div>

    <ul class="result-list no-drag" id="resultList"></ul>

    <div class="status-line no-drag" id="statusLine"></div>

    <footer class="footer no-drag">
      <span id="shortcutHint">Enter 发送文本，Ctrl+Enter 仅按名称启动</span>
      <span>支持粘贴图片 / 拖拽文件</span>
    </footer>
  </main>

  <script>
    (() => {
      const launcherApi = window.launcherApi;
      const shell = document.getElementById('launcherShell');
      const queryInput = document.getElementById('queryInput');
      const resultList = document.getElementById('resultList');
      const resultCount = document.getElementById('resultCount');
      const statusLine = document.getElementById('statusLine');
      const payloadBar = document.getElementById('payloadBar');
      const payloadKind = document.getElementById('payloadKind');
      const payloadText = document.getElementById('payloadText');
      const clearAttachmentBtn = document.getElementById('clearAttachmentBtn');
      const shortcutHint = document.getElementById('shortcutHint');

      const state = {
        prompts: [],
        filtered: [],
        selectedIndex: -1,
        attachment: null,
        showResults: false,
      };

      const cmdKey = launcherApi.platform === 'darwin' ? 'Cmd' : 'Ctrl';
      shortcutHint.textContent = `Enter 发送文本，${cmdKey}+Enter 仅按名称启动`;

      function normalizePromptType(rawType) {
        const value = String(rawType || 'general').toLowerCase();
        if (value === 'text') return 'over';
        if (value === 'image') return 'img';
        if (value === 'file') return 'files';
        return value;
      }

      function typeTag(type) {
        if (type === 'over') return 'TEXT';
        if (type === 'img') return 'IMAGE';
        if (type === 'files') return 'FILES';
        return 'GENERAL';
      }

      function parseRegexLiteral(value) {
        if (typeof value !== 'string') return null;
        const trimmed = value.trim();
        if (!trimmed) return null;
        if (!trimmed.startsWith('/')) return null;

        const tail = trimmed.lastIndexOf('/');
        if (tail <= 0) return null;

        const body = trimmed.slice(1, tail);
        const flags = trimmed.slice(tail + 1);

        try {
          return new RegExp(body, flags);
        } catch (_error) {
          return null;
        }
      }

      function supportsAttachment(prompt, attachmentKind) {
        if (!attachmentKind) return true;
        const type = normalizePromptType(prompt.type);
        if (attachmentKind === 'img') return type === 'general' || type === 'img';
        if (attachmentKind === 'files') return type === 'general' || type === 'files';
        return true;
      }

      function supportsTextPayload(prompt, textPayload) {
        const type = normalizePromptType(prompt.type);
        if (type !== 'general' && type !== 'over') return false;

        if (type === 'over' && textPayload) {
          const regex = parseRegexLiteral(prompt.matchRegex);
          if (regex) return regex.test(textPayload);
        }

        return true;
      }

      function promptScore(prompt, query) {
        if (!query) return 0;
        const name = String(prompt.code || '').toLowerCase();
        const description = String(prompt.prompt || '').toLowerCase();

        if (name === query) return 1000;
        if (name.startsWith(query)) return 620;
        if (name.includes(query)) return 420;
        if (description.includes(query)) return 120;
        return 0;
      }

      function setStatus(message, isError = false) {
        statusLine.textContent = message || '';
        statusLine.classList.toggle('error', !!message && isError);
      }

      function setAttachment(attachment) {
        state.attachment = attachment;
        clearAttachmentBtn.hidden = !attachment;

        if (!attachment) {
          payloadBar.classList.remove('visible');
          payloadKind.textContent = '';
          payloadText.textContent = '';
          applyFilter();
          return;
        }

        payloadBar.classList.add('visible');
        if (attachment.kind === 'img') {
          payloadKind.textContent = 'IMAGE';
          payloadText.textContent = attachment.name || '剪贴板图片';
        } else {
          payloadKind.textContent = 'FILES';
          payloadText.textContent = `${attachment.files.length} 个文件`;
        }
        applyFilter();
      }

      function clearAttachment() {
        setAttachment(null);
      }

      function renderList() {
        resultList.classList.toggle('visible', state.showResults);
        if (!state.showResults) {
          resultList.innerHTML = '';
          return;
        }

        resultList.innerHTML = '';

        if (state.filtered.length === 0) {
          const empty = document.createElement('li');
          empty.className = 'empty-state';
          empty.textContent = state.prompts.length === 0
            ? '未检测到可用助手，请先在设置中启用。'
            : '无匹配项，可更换关键词或清除附件。';
          resultList.appendChild(empty);
          return;
        }

        state.filtered.forEach((prompt, index) => {
          const item = document.createElement('li');
          item.className = 'prompt-item';
          if (index === state.selectedIndex) {
            item.classList.add('selected');
          }

          const icon = document.createElement('div');
          icon.className = 'prompt-icon';
          if (prompt.icon) {
            const img = document.createElement('img');
            const source = prompt.icon.startsWith('data:')
              ? prompt.icon
              : `data:image/png;base64,${prompt.icon}`;
            img.src = source;
            img.alt = '';
            img.onerror = () => {
              icon.textContent = String(prompt.code || '?').slice(0, 2).toUpperCase();
            };
            icon.appendChild(img);
          } else {
            icon.textContent = String(prompt.code || '?').slice(0, 2).toUpperCase();
          }

          const info = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'prompt-title';
          title.textContent = prompt.code;
          const desc = document.createElement('div');
          desc.className = 'prompt-desc';
          desc.textContent = prompt.prompt || '无描述';
          info.appendChild(title);
          info.appendChild(desc);

          const tag = document.createElement('div');
          tag.className = 'prompt-tag';
          tag.textContent = typeTag(normalizePromptType(prompt.type));

          item.appendChild(icon);
          item.appendChild(info);
          item.appendChild(tag);

          item.addEventListener('mouseenter', () => {
            state.selectedIndex = index;
            renderList();
          });

          item.addEventListener('mousedown', (event) => {
            event.preventDefault();
          });

          item.addEventListener('click', () => {
            executeCurrent(true);
          });

          resultList.appendChild(item);
        });

        scrollSelectedIntoView();
      }

      function scrollSelectedIntoView() {
        if (state.selectedIndex < 0) return;
        const selected = resultList.querySelector('.prompt-item.selected');
        if (selected && typeof selected.scrollIntoView === 'function') {
          selected.scrollIntoView({ block: 'nearest' });
        }
      }

      function applyFilter() {
        const query = queryInput.value.trim().toLowerCase();
        const attachmentKind = state.attachment ? state.attachment.kind : '';
        const hasSearchContext = query.length > 0 || !!attachmentKind;

        state.showResults = hasSearchContext;
        if (!hasSearchContext) {
          state.filtered = [];
          state.selectedIndex = -1;
          resultCount.textContent = `0 / ${state.prompts.length}`;
          setStatus('');
          renderList();
          return;
        }

        let list = state.prompts.slice();
        if (attachmentKind) {
          list = list.filter((prompt) => supportsAttachment(prompt, attachmentKind));
        }

        if (query) {
          list = list.filter((prompt) => {
            const code = String(prompt.code || '').toLowerCase();
            const promptText = String(prompt.prompt || '').toLowerCase();
            return code.includes(query) || promptText.includes(query);
          });
        }

        list.sort((a, b) => {
          const scoreDiff = promptScore(b, query) - promptScore(a, query);
          if (scoreDiff !== 0) return scoreDiff;
          return String(a.code || '').localeCompare(String(b.code || ''));
        });

        state.filtered = list;
        if (state.filtered.length === 0) {
          state.selectedIndex = -1;
        } else if (state.selectedIndex < 0 || state.selectedIndex >= state.filtered.length) {
          state.selectedIndex = 0;
        }

        resultCount.textContent = `${state.filtered.length} / ${state.prompts.length}`;
        renderList();
      }

      function buildAction(prompt, useTextPayload) {
        if (state.attachment?.kind === 'img') {
          return { code: prompt.code, type: 'img', payload: state.attachment.dataUrl };
        }
        if (state.attachment?.kind === 'files') {
          return { code: prompt.code, type: 'files', payload: state.attachment.files };
        }

        const query = queryInput.value.trim();
        if (useTextPayload && query) {
          return { code: prompt.code, type: 'over', payload: query };
        }

        return { code: prompt.code, type: 'over', payload: '' };
      }

      function executeCurrent(useTextPayload) {
        if (state.selectedIndex < 0 || state.selectedIndex >= state.filtered.length) return;
        const prompt = state.filtered[state.selectedIndex];
        if (!prompt) return;

        const query = queryInput.value.trim();
        if (state.attachment && !supportsAttachment(prompt, state.attachment.kind)) {
          setStatus('该助手不支持当前附件类型。', true);
          return;
        }

        if (!state.attachment && useTextPayload && query && !supportsTextPayload(prompt, query)) {
          setStatus(`该助手不支持文本输入，按 ${cmdKey}+Enter 可仅按名称启动。`, true);
          return;
        }

        launcherApi.execute(buildAction(prompt, useTextPayload));
      }

      function shiftSelection(step) {
        if (state.filtered.length === 0) return;
        if (state.selectedIndex < 0) state.selectedIndex = 0;
        else state.selectedIndex = (state.selectedIndex + step + state.filtered.length) % state.filtered.length;
        renderList();
      }

      function fileToDataUrl(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(typeof reader.result === 'string' ? reader.result : '');
          reader.onerror = () => resolve('');
          reader.readAsDataURL(file);
        });
      }

      async function consumeFiles(fileList) {
        const files = Array.from(fileList || []);
        if (files.length === 0) return;

        const filePayload = files
          .map((file) => ({
            name: file.name || 'file',
            path: typeof file.path === 'string' ? file.path : '',
            isFile: true,
          }))
          .filter((file) => !!file.path);

        if (filePayload.length > 0) {
          setAttachment({ kind: 'files', files: filePayload });
          setStatus(`已附加 ${filePayload.length} 个文件。`);
          return;
        }

        if (files.length === 1 && String(files[0].type || '').startsWith('image/')) {
          const dataUrl = await fileToDataUrl(files[0]);
          if (dataUrl) {
            setAttachment({
              kind: 'img',
              dataUrl,
              name: files[0].name || 'clipboard-image.png',
            });
            setStatus('已附加图片。');
            return;
          }
        }

        setStatus('无法读取该附件，请尝试拖拽本地文件或直接粘贴图片。', true);
      }

      async function refreshPrompts() {
        try {
          const prompts = await launcherApi.getPrompts();
          state.prompts = Array.isArray(prompts) ? prompts : [];
          state.selectedIndex = 0;
          applyFilter();
          if (state.prompts.length === 0) {
            setStatus('暂无可用助手。');
          } else {
            setStatus('');
          }
        } catch (error) {
          state.prompts = [];
          state.filtered = [];
          state.selectedIndex = -1;
          renderList();
          resultCount.textContent = '0 / 0';
          setStatus(`加载助手失败: ${String(error?.message || error)}`, true);
        }
      }

      async function resetAndRefresh() {
        queryInput.value = '';
        setAttachment(null);
        await refreshPrompts();
        queryInput.focus();
        queryInput.select();
      }

      clearAttachmentBtn.addEventListener('click', () => {
        clearAttachment();
        queryInput.focus();
      });

      queryInput.addEventListener('input', () => {
        setStatus('');
        applyFilter();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          launcherApi.close();
          return;
        }

        if (event.key === 'ArrowDown') {
          event.preventDefault();
          shiftSelection(1);
          return;
        }

        if (event.key === 'ArrowUp') {
          event.preventDefault();
          shiftSelection(-1);
          return;
        }

        if (event.key === 'Enter') {
          event.preventDefault();
          if (!state.showResults) return;
          const useTextPayload = !(event.ctrlKey || event.metaKey);
          executeCurrent(useTextPayload);
        }
      });

      window.addEventListener('dragover', (event) => {
        event.preventDefault();
        shell.classList.add('drag-over');
      });

      window.addEventListener('dragleave', (event) => {
        if (!shell.contains(event.relatedTarget)) {
          shell.classList.remove('drag-over');
        }
      });

      window.addEventListener('drop', async (event) => {
        event.preventDefault();
        shell.classList.remove('drag-over');
        await consumeFiles(event.dataTransfer?.files);
      });

      window.addEventListener('paste', async (event) => {
        const clipboardFiles = event.clipboardData?.files;
        if (clipboardFiles && clipboardFiles.length > 0) {
          event.preventDefault();
          await consumeFiles(clipboardFiles);
          return;
        }

        const imageData = launcherApi.readClipboardImage();
        if (imageData) {
          event.preventDefault();
          setAttachment({
            kind: 'img',
            dataUrl: imageData,
            name: 'clipboard-image.png',
          });
          setStatus('已附加剪贴板图片。');
        }
      });

      launcherApi.onRefresh(() => {
        resetAndRefresh();
      });

      launcherApi.onFocusInput(() => {
        queryInput.focus();
      });

      resetAndRefresh();
    })();
  </script>
</body>
</html>
